name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Optimize build performance
  RUSTFLAGS: "-C link-arg=-fuse-ld=lld"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            postgresql \
            postgresql-contrib \
            lld \
            clang

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.3

      - name: Start PostgreSQL
        run: |
          sudo systemctl start postgresql || true
          
          # Create database if it doesn't exist
          sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname = 'nexus'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE DATABASE nexus;"
          
          # Create user if it doesn't exist
          sudo -u postgres psql -tc "SELECT 1 FROM pg_user WHERE usename = 'nexus'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE USER nexus WITH PASSWORD 'nexus';"
          
          # Grant privileges (idempotent - safe to run multiple times)
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE nexus TO nexus;" || true
          sudo -u postgres psql -d nexus -c "GRANT ALL ON SCHEMA public TO nexus;" || true
          # CREATEROLE needed for migration 23 (audit schema creates audit_reader role)
          sudo -u postgres psql -c "ALTER USER nexus CREATEROLE;" || true

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Run tests
        run: cargo test --all-features
        env:
          DATABASE_URL: postgresql://nexus:nexus@localhost/nexus

  build:
    name: Build
    runs-on: self-hosted
    strategy:
      matrix:
        profile: [debug, release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            musl-tools \
            lld \
            clang \
            postgresql \
            postgresql-contrib

      - name: Setup PostgreSQL
        run: |
          # Start PostgreSQL if not running
          sudo systemctl start postgresql || true

          # Create database and user if they don't exist
          sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname = 'nexus'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE DATABASE nexus;"

          sudo -u postgres psql -tc "SELECT 1 FROM pg_user WHERE usename = 'nexus'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE USER nexus WITH PASSWORD 'nexus';"

          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE nexus TO nexus;" || true
          sudo -u postgres psql -d nexus -c "GRANT ALL ON SCHEMA public TO nexus;" || true
          # CREATEROLE needed for migration 23 (audit schema creates audit_reader role)
          sudo -u postgres psql -c "ALTER USER nexus CREATEROLE;" || true

      - name: Setup sccache (local)
        run: |
          # Install sccache if not present
          if ! command -v sccache &> /dev/null; then
            curl -L https://github.com/mozilla/sccache/releases/download/v0.7.7/sccache-v0.7.7-x86_64-unknown-linux-musl.tar.gz | tar xz
            sudo mv sccache-*/sccache /usr/local/bin/
          fi
          # Use local disk cache
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "SCCACHE_DIR=$HOME/.cache/sccache" >> $GITHUB_ENV

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Build manager
        run: |
          if [ "${{ matrix.profile }}" = "release" ]; then
            cargo build --release -p manager
          else
            cargo build -p manager
          fi
        env:
          DATABASE_URL: postgresql://nexus:nexus@localhost/nexus

      - name: Build agent
        run: |
          if [ "${{ matrix.profile }}" = "release" ]; then
            cargo build --release -p agent
          else
            cargo build -p agent
          fi

      - name: Build guest-agent (static)
        run: |
          if [ "${{ matrix.profile }}" = "release" ]; then
            cargo build --release --target x86_64-unknown-linux-musl -p guest-agent
          else
            cargo build --target x86_64-unknown-linux-musl -p guest-agent
          fi

      - name: Verify binaries
        run: |
          if [ "${{ matrix.profile }}" = "release" ]; then
            # Verify binaries exist and are executable (skip --version to avoid port conflicts)
            test -x ./target/release/manager
            file ./target/release/manager
            test -x ./target/release/agent
            file ./target/release/agent
            file target/x86_64-unknown-linux-musl/release/guest-agent
          else
            # Verify binaries exist and are executable (skip --version to avoid port conflicts)
            test -x ./target/debug/manager
            file ./target/debug/manager
            test -x ./target/debug/agent
            file ./target/debug/agent
            file target/x86_64-unknown-linux-musl/debug/guest-agent
          fi

      - name: Show sccache statistics
        run: sccache --show-stats

  build-ui:
    name: Build UI
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Cache pnpm
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            apps/ui/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('apps/ui/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        working-directory: apps/ui
        run: pnpm install --frozen-lockfile

      - name: Type check
        working-directory: apps/ui
        run: pnpm type-check || echo "Type check skipped if not configured"

      - name: Lint
        working-directory: apps/ui
        run: pnpm lint || echo "Lint skipped if not configured"

      - name: Build
        working-directory: apps/ui
        run: pnpm build

      - name: Verify build
        run: |
          test -d apps/ui/.next
          echo "UI build successful"

  security-audit:
    name: Security Audit
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

  check-installer-syntax:
    name: Check Installer Syntax
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Check bash syntax
        run: |
          # Check all shell scripts
          find scripts/install -name "*.sh" -type f -exec bash -n {} \;

      - name: Run shellcheck
        run: |
          # Run shellcheck on all scripts
          find scripts/install -name "*.sh" -type f -exec shellcheck -x {} \;

  integration-test:
    name: Integration Test
    runs-on: self-hosted
    needs: [build, build-ui]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            postgresql \
            postgresql-contrib \
            musl-tools \
            lld \
            clang

      - name: Setup sccache (local)
        run: |
          # Install sccache if not present
          if ! command -v sccache &> /dev/null; then
            curl -L https://github.com/mozilla/sccache/releases/download/v0.7.7/sccache-v0.7.7-x86_64-unknown-linux-musl.tar.gz | tar xz
            sudo mv sccache-*/sccache /usr/local/bin/
          fi
          # Use local disk cache
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "SCCACHE_DIR=$HOME/.cache/sccache" >> $GITHUB_ENV

      - name: Start PostgreSQL
        run: |
          # Configure PostgreSQL to listen on localhost
          PG_VERSION=$(ls /etc/postgresql/ | head -1)
          PG_CONF="/etc/postgresql/${PG_VERSION}/main/postgresql.conf"
          PG_HBA="/etc/postgresql/${PG_VERSION}/main/pg_hba.conf"
          
          echo "PostgreSQL version: ${PG_VERSION}"
          
          # Detect the port PostgreSQL is configured to use
          PG_PORT=$(grep -E "^port\s*=" "$PG_CONF" | sed 's/port\s*=\s*//' | tr -d ' ' || echo "5432")
          if [ -z "$PG_PORT" ]; then
            PG_PORT=$(grep -E "#?port\s*=" "$PG_CONF" | head -1 | sed 's/#*port\s*=\s*//' | tr -d ' ' || echo "5432")
          fi
          [ -z "$PG_PORT" ] && PG_PORT="5432"
          echo "PostgreSQL port: ${PG_PORT}"
          echo "PG_PORT=${PG_PORT}" >> $GITHUB_ENV
          
          # Ensure PostgreSQL listens on localhost
          sudo sed -i "s/#listen_addresses = 'localhost'/listen_addresses = 'localhost'/" "$PG_CONF"
          sudo sed -i "s/listen_addresses = ''/listen_addresses = 'localhost'/" "$PG_CONF"
          
          # Add md5 authentication for local TCP connections if not present
          if ! sudo grep -q "host.*nexus.*nexus.*127.0.0.1" "$PG_HBA"; then
            echo "host    nexus           nexus           127.0.0.1/32            md5" | sudo tee -a "$PG_HBA"
            echo "host    nexus           nexus           ::1/128                 md5" | sudo tee -a "$PG_HBA"
          fi
          
          # Restart PostgreSQL to apply changes
          sudo systemctl restart postgresql
          
          # Wait for PostgreSQL to be ready
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if sudo -u postgres psql -c "SELECT 1" > /dev/null 2>&1; then
              echo "PostgreSQL is ready after $i seconds"
              break
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 1
          done

          # Create database if it doesn't exist
          sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname = 'nexus'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE DATABASE nexus;"

          # Create user if it doesn't exist
          sudo -u postgres psql -tc "SELECT 1 FROM pg_user WHERE usename = 'nexus'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE USER nexus WITH PASSWORD 'nexus';"

          # Grant privileges (idempotent - safe to run multiple times)
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE nexus TO nexus;" || true
          sudo -u postgres psql -d nexus -c "GRANT ALL ON SCHEMA public TO nexus;" || true
          # CREATEROLE needed for migration 23 (audit schema creates audit_reader role)
          sudo -u postgres psql -c "ALTER USER nexus CREATEROLE;" || true

          # Verify connection with nexus user via TCP using detected port
          echo "Verifying database connection via TCP on port ${PG_PORT}..."
          for i in {1..10}; do
            if PGPASSWORD=nexus psql -U nexus -d nexus -h 127.0.0.1 -p ${PG_PORT} -c "SELECT 1" > /dev/null 2>&1; then
              echo "Database connection successful!"
              exit 0
            fi
            echo "Connection attempt $i/10 - waiting..."
            sleep 1
          done
          
          echo "Failed to connect to database on port ${PG_PORT}"
          echo "=== PostgreSQL logs ==="
          sudo tail -50 /var/log/postgresql/postgresql-${PG_VERSION}-main.log || true
          exit 1

      - name: Build all components
        run: |
          cargo build --release -p manager
          cargo build --release -p agent
          cargo build --release --target x86_64-unknown-linux-musl -p guest-agent
        env:
          DATABASE_URL: postgresql://nexus:nexus@localhost:${{ env.PG_PORT }}/nexus

      - name: Run database migrations
        working-directory: apps/manager
        run: |
          cargo install sqlx-cli --no-default-features --features postgres
          sqlx migrate run
        env:
          DATABASE_URL: postgresql://nexus:nexus@localhost:${{ env.PG_PORT }}/nexus

      - name: Start manager (background)
        run: |
          # Use a random port to avoid conflicts on self-hosted runners
          MANAGER_PORT=$((18080 + RANDOM % 1000))
          echo "MANAGER_PORT=$MANAGER_PORT" >> $GITHUB_ENV

          # Kill any existing process on the port (cleanup from previous runs)
          fuser -k $MANAGER_PORT/tcp 2>/dev/null || true
          sleep 1

          export DATABASE_URL=postgresql://nexus:nexus@localhost:${PG_PORT}/nexus
          export MANAGER_BIND=127.0.0.1:$MANAGER_PORT
          export MANAGER_ALLOW_IMAGE_PATHS=true
          export MANAGER_RECONCILER_DISABLED=1
          ./target/release/manager > /tmp/manager.log 2>&1 &
          MANAGER_PID=$!
          echo "MANAGER_PID=$MANAGER_PID" >> $GITHUB_ENV
          echo "Manager started with PID $MANAGER_PID on port $MANAGER_PORT"

      - name: Wait for manager to be ready
        run: |
          echo "Waiting for manager to be ready on port $MANAGER_PORT..."
          for i in {1..30}; do
            if curl -sf http://localhost:$MANAGER_PORT/health > /dev/null 2>&1; then
              echo "Manager is ready after $i seconds"
              exit 0
            fi
            # Check if process is still running
            if ! kill -0 $MANAGER_PID 2>/dev/null; then
              echo "Manager process died!"
              echo "=== Manager logs ==="
              cat /tmp/manager.log || true
              exit 1
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 1
          done
          echo "Manager failed to start within 30 seconds"
          echo "=== Manager logs ==="
          cat /tmp/manager.log || true
          exit 1

      - name: Test manager API
        run: |
          # Health check
          curl -f http://localhost:$MANAGER_PORT/health

          # Check API version
          curl -f http://localhost:$MANAGER_PORT/v1/vms

          echo "Manager API is responding!"

      - name: Show manager logs on failure
        if: failure()
        run: |
          echo "=== Manager logs ==="
          cat /tmp/manager.log || echo "No log file found"

      - name: Stop manager
        if: always()
        run: |
          if [ -n "$MANAGER_PID" ]; then
            kill $MANAGER_PID || true
          fi
