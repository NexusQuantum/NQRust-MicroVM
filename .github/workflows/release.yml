name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Optimize build performance
  RUSTFLAGS: "-C link-arg=-fuse-ld=lld"

jobs:
  # Gate: Ensure CI passes before building release
  ci-gate:
    name: CI Gate
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

      - name: Check shell scripts
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          find scripts/install -name "*.sh" -type f -exec bash -n {} \;
          find scripts/install -name "*.sh" -type f -exec shellcheck -x {} \;

  build-binaries:
    name: Build Release Binaries
    needs: ci-gate
    runs-on: self-hosted
    # Alternatives:
    # runs-on: ubuntu-24.04
    # runs-on: buildjet-4vcpu-ubuntu-2204
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,x86_64-unknown-linux-musl

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            musl-tools \
            lld \
            clang \
            postgresql \
            postgresql-contrib

      - name: Setup PostgreSQL
        run: |
          # Start PostgreSQL if not running
          sudo systemctl start postgresql || true

          # Create database and user if they don't exist
          sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname = 'nexus'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE DATABASE nexus;"

          sudo -u postgres psql -tc "SELECT 1 FROM pg_user WHERE usename = 'nexus'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE USER nexus WITH PASSWORD 'nexus';"

          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE nexus TO nexus;" || true
          sudo -u postgres psql -d nexus -c "GRANT ALL ON SCHEMA public TO nexus;" || true

      - name: Setup sccache (local)
        run: |
          # Install sccache if not present
          if ! command -v sccache &> /dev/null; then
            curl -L https://github.com/mozilla/sccache/releases/download/v0.7.7/sccache-v0.7.7-x86_64-unknown-linux-musl.tar.gz | tar xz
            sudo mv sccache-*/sccache /usr/local/bin/
          fi
          # Use local disk cache
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "SCCACHE_DIR=$HOME/.cache/sccache" >> $GITHUB_ENV

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Build manager (release)
        run: cargo build --release -p manager
        env:
          DATABASE_URL: postgresql://nexus:nexus@localhost/nexus

      - name: Build agent (release)
        run: cargo build --release -p agent

      - name: Build guest-agent (static musl)
        run: cargo build --release --target x86_64-unknown-linux-musl -p guest-agent

      - name: Build installer (static musl)
        run: cargo build --release --target x86_64-unknown-linux-musl -p nqr-installer

      - name: Verify binaries
        run: |
          # Verify binaries exist and are executable (skip --version to avoid port conflicts)
          test -x ./target/release/manager
          file ./target/release/manager
          test -x ./target/release/agent
          file ./target/release/agent
          # Check guest-agent is statically linked (handles both "statically linked" and "static-pie linked")
          file target/x86_64-unknown-linux-musl/release/guest-agent | grep -E "static.*linked"
          # Check installer is statically linked
          test -x target/x86_64-unknown-linux-musl/release/nqr-installer
          file target/x86_64-unknown-linux-musl/release/nqr-installer | grep -E "static.*linked"

      - name: Rename binaries with target suffix
        run: |
          cp target/release/manager nqrust-manager-${{ matrix.target }}
          cp target/release/agent nqrust-agent-${{ matrix.target }}
          cp target/x86_64-unknown-linux-musl/release/guest-agent nqrust-guest-agent-x86_64-linux-musl
          cp target/x86_64-unknown-linux-musl/release/nqr-installer nqr-installer-x86_64-linux-musl

      - name: Upload binaries as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.target }}
          path: |
            nqrust-manager-${{ matrix.target }}
            nqrust-agent-${{ matrix.target }}
            nqrust-guest-agent-x86_64-linux-musl
            nqr-installer-x86_64-linux-musl
          retention-days: 1

      - name: Show sccache statistics
        run: sccache --show-stats

  build-images:
    name: Build Base Images
    needs: ci-gate
    runs-on: self-hosted
    # This job builds VM images (kernels, rootfs, runtimes)
    # Requires: KVM access, ~10GB disk space, internet for downloads

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-utils \
            debootstrap \
            e2fsprogs \
            curl \
            xz-utils \
            cpio \
            bc \
            flex \
            bison \
            libelf-dev \
            libssl-dev

      - name: Create images directory
        run: mkdir -p images/

      - name: Download Firecracker kernel
        run: |
          # Download pre-built Firecracker kernel 5.10
          curl -fsSL -o images/vmlinux-5.10.fc.bin \
            https://s3.amazonaws.com/spec.ccfc.min/img/quickstart_guide/x86_64/kernels/vmlinux.bin
          ls -lh images/vmlinux-5.10.fc.bin

      - name: Build Alpine rootfs
        run: |
          # Use pre-built Alpine mini root filesystem
          ALPINE_VERSION=3.18
          curl -fsSL -o /tmp/alpine-minirootfs.tar.gz \
            https://dl-cdn.alpinelinux.org/alpine/v${ALPINE_VERSION}/releases/x86_64/alpine-minirootfs-${ALPINE_VERSION}.0-x86_64.tar.gz

          # Create ext4 image (50MB for Alpine minirootfs - it's about 8MB compressed but needs space for extraction)
          dd if=/dev/zero of=images/alpine-3.18-minimal.ext4 bs=1M count=50
          mkfs.ext4 -F images/alpine-3.18-minimal.ext4

          # Mount and populate
          sudo mkdir -p /mnt/alpine
          sudo mount -o loop images/alpine-3.18-minimal.ext4 /mnt/alpine
          sudo tar -xzf /tmp/alpine-minirootfs.tar.gz -C /mnt/alpine

          # Basic setup
          sudo sh -c 'echo "nameserver 8.8.8.8" > /mnt/alpine/etc/resolv.conf'
          sudo chroot /mnt/alpine sh -c 'echo "root:root" | chpasswd' || true

          sudo umount /mnt/alpine
          ls -lh images/alpine-3.18-minimal.ext4

      - name: Build BusyBox rootfs
        run: |
          # Create minimal BusyBox rootfs
          # Using 1.35.0 - latest available pre-built binary from busybox.net
          curl -fsSL -o /tmp/busybox \
            https://busybox.net/downloads/binaries/1.35.0-x86_64-linux-musl/busybox

          # Create ext4 image (80MB for BusyBox with basic utilities)
          dd if=/dev/zero of=images/busybox-1.35.ext4 bs=1M count=80
          mkfs.ext4 -F images/busybox-1.35.ext4

          # Mount and populate
          sudo mkdir -p /mnt/busybox
          sudo mount -o loop images/busybox-1.35.ext4 /mnt/busybox

          # Create directory structure
          sudo mkdir -p /mnt/busybox/{bin,sbin,etc,proc,sys,usr/bin,usr/sbin,dev,tmp,root,var/run}

          # Install BusyBox
          sudo cp /tmp/busybox /mnt/busybox/bin/busybox
          sudo chmod +x /mnt/busybox/bin/busybox
          sudo chroot /mnt/busybox /bin/busybox --install -s

          # Basic init script
          sudo tee /mnt/busybox/init > /dev/null <<'INIT'
          #!/bin/sh
          mount -t proc proc /proc
          mount -t sysfs sysfs /sys
          mount -t devtmpfs devtmpfs /dev
          exec /bin/sh
          INIT
          sudo chmod +x /mnt/busybox/init

          sudo umount /mnt/busybox
          ls -lh images/busybox-1.35.ext4

      - name: Build Ubuntu minimal rootfs
        run: |
          # Build minimal Ubuntu 24.04 rootfs using debootstrap
          sudo debootstrap --variant=minbase --include=systemd,systemd-sysv,openssh-server,curl,iproute2,iputils-ping \
            noble /tmp/ubuntu-rootfs http://archive.ubuntu.com/ubuntu/

          # Create ext4 image (800MB for Ubuntu minimal)
          dd if=/dev/zero of=images/ubuntu-24.04-minimal.ext4 bs=1M count=800
          mkfs.ext4 -F images/ubuntu-24.04-minimal.ext4

          # Mount and copy
          sudo mkdir -p /mnt/ubuntu
          sudo mount -o loop images/ubuntu-24.04-minimal.ext4 /mnt/ubuntu
          sudo cp -a /tmp/ubuntu-rootfs/* /mnt/ubuntu/

          # Set root password
          sudo chroot /mnt/ubuntu sh -c 'echo "root:root" | chpasswd'

          # Enable serial console
          sudo chroot /mnt/ubuntu systemctl enable serial-getty@ttyS0.service || true

          sudo umount /mnt/ubuntu
          ls -lh images/ubuntu-24.04-minimal.ext4

      - name: Build Node.js function runtime
        run: |
          # Build Node.js runtime for serverless functions (Alpine-based, matches scripts)
          ALPINE_VERSION=3.18
          curl -fsSL -o /tmp/alpine-node.tar.gz \
            https://dl-cdn.alpinelinux.org/alpine/v${ALPINE_VERSION}/releases/x86_64/alpine-minirootfs-${ALPINE_VERSION}.0-x86_64.tar.gz

          # Create rootfs directory
          sudo mkdir -p /tmp/node-rootfs
          sudo tar -xzf /tmp/alpine-node.tar.gz -C /tmp/node-rootfs

          # Configure DNS
          sudo cp /etc/resolv.conf /tmp/node-rootfs/etc/resolv.conf

          # Install Node.js and dependencies
          sudo chroot /tmp/node-rootfs sh -c '
            apk update
            apk add --no-cache nodejs npm openrc util-linux coreutils
            rc-update add devfs boot
            rc-update add procfs boot
            rc-update add sysfs boot
            rc-update add networking boot
          '

          # Install runtime server
          sudo mkdir -p /tmp/node-rootfs/function
          sudo cp apps/function-runtime/node/server.js /tmp/node-rootfs/usr/local/bin/runtime-server
          sudo chmod +x /tmp/node-rootfs/usr/local/bin/runtime-server

          # Create placeholder function
          sudo tee /tmp/node-rootfs/function/code.js > /dev/null <<'FUNC'
          async function handler(event) {
              return { message: "Hello from NQRust Lambda!", event, timestamp: new Date().toISOString() };
          }
          module.exports = { handler };
          FUNC

          # Create OpenRC service for runtime server
          sudo tee /tmp/node-rootfs/etc/init.d/runtime-server > /dev/null <<'SERVICE'
          #!/sbin/openrc-run
          name="runtime-server"
          description="NQRust Lambda Runtime Server (Node.js)"
          command="/usr/bin/node"
          command_args="/usr/local/bin/runtime-server"
          command_background=true
          pidfile="/run/runtime-server.pid"
          depend() { need net; after networking; }
          SERVICE
          sudo chmod +x /tmp/node-rootfs/etc/init.d/runtime-server
          sudo chroot /tmp/node-rootfs rc-update add runtime-server default

          # Configure networking
          sudo tee /tmp/node-rootfs/etc/network/interfaces > /dev/null <<'NET'
          auto lo
          iface lo inet loopback
          auto eth0
          iface eth0 inet dhcp
          NET

          echo "lambda-node" | sudo tee /tmp/node-rootfs/etc/hostname
          sudo sed -i 's/root:!:/root::/' /tmp/node-rootfs/etc/shadow 2>/dev/null || true

          # Create ext4 image (500MB for Node.js runtime - Alpine is much smaller)
          dd if=/dev/zero of=images/node-runtime.ext4 bs=1M count=500
          mkfs.ext4 -F images/node-runtime.ext4

          sudo mkdir -p /mnt/node
          sudo mount -o loop images/node-runtime.ext4 /mnt/node
          sudo cp -a /tmp/node-rootfs/* /mnt/node/
          sudo umount /mnt/node
          ls -lh images/node-runtime.ext4

      - name: Build Python function runtime
        run: |
          # Build Python runtime for serverless functions (Alpine-based, matches scripts)
          ALPINE_VERSION=3.18
          curl -fsSL -o /tmp/alpine-python.tar.gz \
            https://dl-cdn.alpinelinux.org/alpine/v${ALPINE_VERSION}/releases/x86_64/alpine-minirootfs-${ALPINE_VERSION}.0-x86_64.tar.gz

          # Create rootfs directory
          sudo mkdir -p /tmp/python-rootfs
          sudo tar -xzf /tmp/alpine-python.tar.gz -C /tmp/python-rootfs

          # Configure DNS
          sudo cp /etc/resolv.conf /tmp/python-rootfs/etc/resolv.conf

          # Install Python and dependencies
          sudo chroot /tmp/python-rootfs sh -c '
            apk update
            apk add --no-cache python3 py3-pip openrc util-linux coreutils
            rc-update add devfs boot
            rc-update add procfs boot
            rc-update add sysfs boot
            rc-update add networking boot
          '

          # Install runtime server
          sudo mkdir -p /tmp/python-rootfs/function
          sudo cp apps/function-runtime/python/server.py /tmp/python-rootfs/usr/local/bin/runtime-server
          sudo chmod +x /tmp/python-rootfs/usr/local/bin/runtime-server

          # Create placeholder function
          sudo tee /tmp/python-rootfs/function/code.py > /dev/null <<'FUNC'
          import datetime
          def handler(event):
              return {"message": "Hello from NQRust Lambda!", "event": event, "timestamp": datetime.datetime.utcnow().isoformat() + "Z"}
          FUNC

          # Create OpenRC service for runtime server
          sudo tee /tmp/python-rootfs/etc/init.d/runtime-server > /dev/null <<'SERVICE'
          #!/sbin/openrc-run
          name="runtime-server"
          description="NQRust Lambda Runtime Server (Python)"
          command="/usr/bin/python3"
          command_args="/usr/local/bin/runtime-server"
          command_background=true
          pidfile="/run/runtime-server.pid"
          depend() { need net; after networking; }
          SERVICE
          sudo chmod +x /tmp/python-rootfs/etc/init.d/runtime-server
          sudo chroot /tmp/python-rootfs rc-update add runtime-server default

          # Configure networking
          sudo tee /tmp/python-rootfs/etc/network/interfaces > /dev/null <<'NET'
          auto lo
          iface lo inet loopback
          auto eth0
          iface eth0 inet dhcp
          NET

          echo "lambda-python" | sudo tee /tmp/python-rootfs/etc/hostname
          sudo sed -i 's/root:!:/root::/' /tmp/python-rootfs/etc/shadow 2>/dev/null || true

          # Create ext4 image (500MB for Python runtime - Alpine is much smaller)
          dd if=/dev/zero of=images/python-runtime.ext4 bs=1M count=500
          mkfs.ext4 -F images/python-runtime.ext4

          sudo mkdir -p /mnt/python
          sudo mount -o loop images/python-runtime.ext4 /mnt/python
          sudo cp -a /tmp/python-rootfs/* /mnt/python/
          sudo umount /mnt/python
          ls -lh images/python-runtime.ext4

      - name: Build container runtime (Alpine + Docker)
        run: |
          # Build container runtime for Docker-in-VM feature (matches scripts/build-container-runtime-v2.sh)
          ALPINE_VERSION=3.18
          curl -fsSL -o /tmp/alpine-container.tar.gz \
            https://dl-cdn.alpinelinux.org/alpine/v${ALPINE_VERSION}/releases/x86_64/alpine-minirootfs-${ALPINE_VERSION}.0-x86_64.tar.gz

          # Create ext4 image (2.2GB for Docker runtime)
          dd if=/dev/zero of=images/container-runtime.ext4 bs=1M count=2200
          mkfs.ext4 -F images/container-runtime.ext4

          sudo mkdir -p /mnt/container
          sudo mount -o loop images/container-runtime.ext4 /mnt/container
          sudo tar -xzf /tmp/alpine-container.tar.gz -C /mnt/container

          # Configure DNS
          sudo cp /etc/resolv.conf /mnt/container/etc/resolv.conf

          # Install Docker and dependencies
          sudo chroot /mnt/container sh -c '
            apk update
            apk add --no-cache \
              docker \
              docker-openrc \
              openrc \
              util-linux \
              coreutils \
              bash \
              curl \
              wget \
              ca-certificates \
              e2fsprogs \
              iptables \
              ip6tables \
              iproute2 \
              bridge-utils \
              openssh \
              shadow

            # Configure OpenRC boot services
            rc-update add devfs boot
            rc-update add procfs boot
            rc-update add sysfs boot
            rc-update add cgroups boot
            rc-update add networking boot
            rc-update add docker default

            # Set root password
            echo "root:root" | chpasswd

            # Configure serial console
            sed -i "s|^#ttyS0|ttyS0|" /etc/inittab 2>/dev/null || true
          '

          # Configure Docker daemon for OpenRC
          sudo mkdir -p /mnt/container/etc/docker /mnt/container/etc/conf.d

          # OpenRC configuration for Docker
          sudo tee /mnt/container/etc/conf.d/docker > /dev/null <<'DOCKERCONF'
          DOCKER_OPTS="-H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375"
          DOCKERCONF

          # Docker daemon JSON config
          sudo tee /mnt/container/etc/docker/daemon.json > /dev/null <<'DOCKERJSON'
          {
              "storage-driver": "overlay2",
              "log-driver": "json-file",
              "log-opts": { "max-size": "10m", "max-file": "3" }
          }
          DOCKERJSON

          # Create network config
          sudo tee /mnt/container/etc/network/interfaces > /dev/null <<'NET'
          auto lo
          iface lo inet loopback

          auto eth0
          iface eth0 inet dhcp
          NET

          echo "container-runtime" | sudo tee /mnt/container/etc/hostname

          sudo umount /mnt/container
          ls -lh images/container-runtime.ext4

      - name: Compress large images
        run: |
          # Compress larger images (>100MB) to reduce upload size
          cd images
          for img in ubuntu-24.04-minimal.ext4 node-runtime.ext4 python-runtime.ext4 container-runtime.ext4; do
            if [ -f "$img" ]; then
              echo "Compressing $img..."
              gzip -9 -k "$img"
              ls -lh "${img}.gz"
            fi
          done
          echo "All images:"
          ls -lh

      - name: Upload images as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: base-images
          path: |
            images/vmlinux-5.10.fc.bin
            images/alpine-3.18-minimal.ext4
            images/busybox-1.35.ext4
            images/ubuntu-24.04-minimal.ext4.gz
            images/node-runtime.ext4.gz
            images/python-runtime.ext4.gz
            images/container-runtime.ext4.gz
          retention-days: 1

  build-ui:
    name: Build UI
    needs: ci-gate
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Cache pnpm
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            apps/ui/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('apps/ui/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install UI dependencies
        working-directory: apps/ui
        run: pnpm install --frozen-lockfile

      - name: Build UI
        working-directory: apps/ui
        run: pnpm build

      - name: Package UI
        run: |
          cd apps/ui
          tar czf ../../nqrust-ui.tar.gz \
            .next/ \
            public/ \
            package.json \
            next.config.mjs \
            pnpm-lock.yaml

      - name: Upload UI as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ui-build
          path: nqrust-ui.tar.gz
          retention-days: 1

  create-release:
    name: Create GitHub Release
    needs: [build-binaries, build-ui, build-images]
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Decompress large images (except container-runtime which exceeds 2GB limit)
        run: |
          cd artifacts/base-images
          for gz in *.gz; do
            if [ -f "$gz" ]; then
              # Skip container-runtime - it's >2GB uncompressed, keep it gzipped
              if [ "$gz" = "container-runtime.ext4.gz" ]; then
                echo "Keeping $gz compressed (>2GB uncompressed)"
                continue
              fi
              gunzip -k "$gz"
            fi
          done
          ls -lh

      - name: Package installer scripts
        run: |
          tar czf nqrust-installer.tar.gz \
            scripts/install/install.sh \
            scripts/install/uninstall.sh \
            scripts/install/README.md \
            scripts/install/lib/ \
            scripts/install/systemd/ \
            scripts/install/sudoers.d/

      - name: Organize release files
        run: |
          mkdir -p release/
          find artifacts/ -type f -name "nqrust-*" -exec cp {} release/ \;
          find artifacts/ -type f -name "nqr-installer-*" -exec cp {} release/ \;
          cp nqrust-installer.tar.gz release/
          # Copy base images (uncompressed .ext4 and kernel)
          cp artifacts/base-images/vmlinux-5.10.fc.bin release/
          cp artifacts/base-images/alpine-3.18-minimal.ext4 release/
          cp artifacts/base-images/busybox-1.35.ext4 release/
          cp artifacts/base-images/ubuntu-24.04-minimal.ext4 release/
          cp artifacts/base-images/node-runtime.ext4 release/
          cp artifacts/base-images/python-runtime.ext4 release/
          # Container runtime stays compressed (>2GB uncompressed exceeds GitHub limit)
          cp artifacts/base-images/container-runtime.ext4.gz release/
          ls -lh release/

      - name: Generate checksums
        working-directory: release
        run: |
          sha256sum nqrust-manager-* > checksums.txt
          sha256sum nqrust-agent-* >> checksums.txt
          sha256sum nqrust-guest-agent-* >> checksums.txt
          sha256sum nqr-installer-* >> checksums.txt
          sha256sum nqrust-ui.tar.gz >> checksums.txt
          sha256sum nqrust-installer.tar.gz >> checksums.txt
          sha256sum vmlinux-*.bin >> checksums.txt
          sha256sum *.ext4 >> checksums.txt
          sha256sum *.ext4.gz >> checksums.txt 2>/dev/null || true
          cat checksums.txt

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Check if this is a pre-release (v0.x.x or contains -alpha, -beta, -rc)
          if [[ "$VERSION" =~ ^v0\. ]] || [[ "$VERSION" =~ -(alpha|beta|rc) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create release manifest
        working-directory: release
        run: |
          cat > release-manifest.json <<EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "released_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "min_compatible_version": "v0.1.0",
            "changelog": "See CHANGELOG.md for details",
            "components": {
              "manager": {
                "version": "${{ steps.version.outputs.version }}",
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqrust-manager-x86_64-unknown-linux-gnu",
                "checksum": "$(sha256sum nqrust-manager-x86_64-unknown-linux-gnu | cut -d' ' -f1)",
                "size": $(stat -f%z nqrust-manager-x86_64-unknown-linux-gnu 2>/dev/null || stat -c%s nqrust-manager-x86_64-unknown-linux-gnu)
              },
              "agent": {
                "version": "${{ steps.version.outputs.version }}",
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqrust-agent-x86_64-unknown-linux-gnu",
                "checksum": "$(sha256sum nqrust-agent-x86_64-unknown-linux-gnu | cut -d' ' -f1)",
                "size": $(stat -f%z nqrust-agent-x86_64-unknown-linux-gnu 2>/dev/null || stat -c%s nqrust-agent-x86_64-unknown-linux-gnu)
              },
              "guest-agent": {
                "version": "${{ steps.version.outputs.version }}",
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqrust-guest-agent-x86_64-linux-musl",
                "checksum": "$(sha256sum nqrust-guest-agent-x86_64-linux-musl | cut -d' ' -f1)",
                "size": $(stat -f%z nqrust-guest-agent-x86_64-linux-musl 2>/dev/null || stat -c%s nqrust-guest-agent-x86_64-linux-musl)
              },
              "ui": {
                "version": "${{ steps.version.outputs.version }}",
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqrust-ui.tar.gz",
                "checksum": "$(sha256sum nqrust-ui.tar.gz | cut -d' ' -f1)",
                "size": $(stat -f%z nqrust-ui.tar.gz 2>/dev/null || stat -c%s nqrust-ui.tar.gz)
              },
              "installer": {
                "version": "${{ steps.version.outputs.version }}",
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqrust-installer.tar.gz",
                "checksum": "$(sha256sum nqrust-installer.tar.gz | cut -d' ' -f1)",
                "size": $(stat -f%z nqrust-installer.tar.gz 2>/dev/null || stat -c%s nqrust-installer.tar.gz)
              }
            },
            "migrations": {
              "from": "v0.1.0",
              "requires_downtime": false,
              "breaking_changes": false
            }
          }
          EOF

          cat release-manifest.json
          jq '.' release-manifest.json  # Validate JSON

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md <<'EOF'
          ## NQRust-MicroVM ${{ steps.version.outputs.version }}

          ### Installation

          **Quick Install (Ubuntu 22.04+):**
          ```bash
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install/install.sh | bash
          ```

          **Manual Install:**
          ```bash
          # Download installer
          curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqr-installer-x86_64-linux-musl
          chmod +x nqr-installer-x86_64-linux-musl

          # Run installer (interactive TUI)
          sudo ./nqr-installer-x86_64-linux-musl install

          # Or with options
          sudo ./nqr-installer-x86_64-linux-musl install --mode production --yes
          ```

          ### Pre-built Binaries

          Download and install manually:
          - **Installer (Rust TUI)**: [nqr-installer-x86_64-linux-musl](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqr-installer-x86_64-linux-musl) (Recommended)
          - Manager: [nqrust-manager-x86_64-unknown-linux-gnu](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqrust-manager-x86_64-unknown-linux-gnu)
          - Agent: [nqrust-agent-x86_64-unknown-linux-gnu](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqrust-agent-x86_64-unknown-linux-gnu)
          - Guest Agent: [nqrust-guest-agent-x86_64-linux-musl](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqrust-guest-agent-x86_64-linux-musl)
          - UI: [nqrust-ui.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqrust-ui.tar.gz)
          - Legacy Installer Scripts: [nqrust-installer.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/nqrust-installer.tar.gz)

          ### Base Images (for VMs and Functions)

          The installer downloads these automatically, or download manually:
          - **Kernel**: [vmlinux-5.10.fc.bin](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/vmlinux-5.10.fc.bin) - Firecracker kernel 5.10
          - **Alpine**: [alpine-3.18-minimal.ext4](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/alpine-3.18-minimal.ext4) - Alpine Linux 3.18 minimal
          - **BusyBox**: [busybox-1.35.ext4](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/busybox-1.35.ext4) - BusyBox 1.35
          - **Ubuntu**: [ubuntu-24.04-minimal.ext4](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/ubuntu-24.04-minimal.ext4) - Ubuntu 24.04 minimal
          - **Node.js Runtime**: [node-runtime.ext4](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/node-runtime.ext4) - For serverless functions
          - **Python Runtime**: [python-runtime.ext4](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/python-runtime.ext4) - For serverless functions
          - **Container Runtime**: [container-runtime.ext4.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/container-runtime.ext4.gz) - Docker-in-VM (~2.2GB, gzipped)

          ### Checksums
          ```
          $(cat release/checksums.txt)
          ```

          ### Requirements
          - Ubuntu 22.04+ or Debian 11+ or RHEL 8+
          - x86_64 CPU with KVM support
          - 2GB+ RAM
          - 20GB+ disk space

          ### What's New
          - See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details

          ### Documentation
          - [Installation Guide](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Quick Start](https://github.com/${{ github.repository }}/blob/main/RUN.md)
          - [Features](https://github.com/${{ github.repository }}/blob/main/FEATURES.md)
          EOF

          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: ${{ steps.release_notes.outputs.notes_file }}
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease }}
          files: |
            release/nqrust-manager-x86_64-unknown-linux-gnu
            release/nqrust-agent-x86_64-unknown-linux-gnu
            release/nqrust-guest-agent-x86_64-linux-musl
            release/nqr-installer-x86_64-linux-musl
            release/nqrust-ui.tar.gz
            release/nqrust-installer.tar.gz
            release/checksums.txt
            release/release-manifest.json
            release/vmlinux-5.10.fc.bin
            release/alpine-3.18-minimal.ext4
            release/busybox-1.35.ext4
            release/ubuntu-24.04-minimal.ext4
            release/node-runtime.ext4
            release/python-runtime.ext4
            release/container-runtime.ext4.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release manifest as latest
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Release
          body: "Latest release manifest for auto-updater"
          draft: false
          prerelease: false
          files: release/release-manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # TODO: Re-enable installer tests in v0.1.1 after fixing disk space and permission issues
  # test-installer:
  #   name: Test Installer
  #   needs: create-release
  #   runs-on: ubuntu-24.04
  #   strategy:
  #     matrix:
  #       mode: [production, dev, manager, agent]
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Test installer (${{ matrix.mode }} mode)
  #       run: |
  #         # Test in non-interactive mode (installer will use sudo internally)
  #         # Use /tmp for logs to avoid permission issues in CI
  #         LOG_DIR=/tmp/nqrust-install bash scripts/install/install.sh \
  #           --mode ${{ matrix.mode }} \
  #           --non-interactive \
  #           --network-mode nat
  #
  #     - name: Verify services
  #       if: matrix.mode != 'agent'
  #       run: |
  #         systemctl is-active nqrust-manager
  #         curl -f http://localhost:18080/health
  #
  #     - name: Verify agent
  #       if: matrix.mode != 'manager'
  #       run: |
  #         systemctl is-active nqrust-agent
  #         curl -f http://localhost:9090/health
  #
  #     - name: Show logs on failure
  #       if: failure()
  #       run: |
  #         journalctl -u nqrust-manager -n 100 --no-pager || true
  #         journalctl -u nqrust-agent -n 100 --no-pager || true
  #
  #     - name: Test uninstaller
  #       run: |
  #         bash scripts/install/uninstall.sh \
  #           --force \
  #           --remove-all
